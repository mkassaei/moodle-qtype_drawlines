/**
 * JavaScript to allow dragging options for lines (using mouse down or touch) or tab through lines using keyboard.
 *
 * @module     qtype_drawlines/question
 * @copyright  2024 The Open University
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("qtype_drawlines/question",["jquery","core/dragdrop","qtype_drawlines/line","core/key_codes","core_form/changechecker"],(function($,dragDrop,Line){function DrawlinesQuestion(containerId,readOnly,visibleDropZones,questionLines){this.containerId=containerId,this.visibleDropZones=visibleDropZones,this.questionLines=questionLines,M.util.js_pending("qtype_drawlines-init-"+this.containerId),this.lineSVGs=[],this.lines=[],this.svgEl=null,this.isPrinting=!1,readOnly&&this.getRoot().classList.add("qtype_drawlines-readonly");let bgImage=this.bgImage();this.createSvgOnImageLoad(bgImage)}DrawlinesQuestion.prototype.updateCoordinates=function(){for(var line=0;line<this.lineSVGs.length;line++){var coordinates=this.getSVGLineCoordinates(this.lineSVGs[line]);if(!this.lines[line].parse(coordinates[0],coordinates[1],1))return;this.updateSvgEl(line)}},DrawlinesQuestion.prototype.parseCoordinates=function(coordinates,lineType){var bits=coordinates.split(" ");if("lineinfinite"===lineType&&2!==bits.length&&(bits=bits.slice(1,-1)),2!==bits.length)throw new Error(coordinates+" is not a valid point");return bits},DrawlinesQuestion.prototype.drawDropzone=function(){let rootElement=this.getRoot(),bgImage=this.bgImage(),svg=rootElement.querySelector("svg.dropzones");if(rootElement.querySelector(".que-dlines-dropzone").style.position="relative",rootElement.querySelector(".que-dlines-dropzone").style.top=-1*(bgImage.height+1)+"px",rootElement.querySelector(".que-dlines-dropzone").style.height=bgImage.height+"px",rootElement.querySelector(".droparea").style.height=bgImage.height+"px",!svg){rootElement.querySelector(".que-dlines-dropzone").innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class= "dropzones" width="'+bgImage.width+'" height="'+bgImage.height+'" viewBox="0 0 '+bgImage.width+" "+bgImage.height+'" preserveAspectRatio="xMinYMin meet" ></svg>',this.drawSVGLines(this.questionLines)}},DrawlinesQuestion.prototype.drawSVGLines=function(questionLines){let height,startcoordinates,endcoordinates,draginitialcoords,bgImage=this.bgImage(),rootElement=this.getRoot();rootElement.querySelector(".draghomes").innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class="dragshome" width="'+bgImage.width+'" height="'+50*questionLines.length+'"></svg>';let draghomeSvg=rootElement.querySelector(".dragshome"),dropzoneSvg=rootElement.querySelector(".dropzones");for(let line=0;line<this.questionLines.length;line++)if(height=25+50*line,startcoordinates="50,"+height+";10",endcoordinates="200,"+height+";10",draginitialcoords=this.visibleDropZones["c"+line],void 0!==draginitialcoords&&""!==draginitialcoords){var coords=this.parseCoordinates(draginitialcoords,questionLines[line].type);startcoordinates=coords[0]+";10",endcoordinates=coords[1]+";10",this.lines[line]=Line.make([startcoordinates,endcoordinates],questionLines[line].type,[questionLines[line].labelstart,questionLines[line].labelmiddle,questionLines[line].labelend]),this.addToSvg(line,dropzoneSvg)}else this.lines[line]=Line.make([startcoordinates,endcoordinates],questionLines[line].type,[questionLines[line].labelstart,questionLines[line].labelmiddle,questionLines[line].labelend]),this.addToSvg(line,draghomeSvg);M.util.js_complete("qtype_drawlines-init-"+this.containerId)},DrawlinesQuestion.prototype.handleResize=function(){let svgdropzones,svgdraghomes,thisQ=this,bgImg=this.bgImage(),bgRatio=this.bgRatio();thisQ.drawDropzone(),svgdropzones=this.getRoot().querySelector("div.droparea svg.dropzones"),svgdraghomes=this.getRoot().querySelector("div.draghomes svg.dragshome"),svgdropzones.setAttribute("width",bgImg.width),svgdropzones.setAttribute("height",bgImg.height),svgdropzones.setAttribute("viewBox","0 0 "+bgImg.width+" "+bgImg.height),svgdraghomes.setAttribute("width",bgImg.width),svgdraghomes.setAttribute("height",parseInt(50*thisQ.questionLines.length*bgRatio));for(let linenumber=0;linenumber<thisQ.questionLines.length;linenumber++){var svgline=thisQ.getRoot().querySelector(".dropzone.choice"+linenumber);thisQ.handleElementScale(svgline)}},DrawlinesQuestion.prototype.bgRatio=function(){var bgImg=this.bgImage(),bgImgNaturalWidth=bgImg.naturalWidth,bgImgClientWidth=bgImg.width;return 0===bgImgClientWidth?1:bgImgClientWidth/bgImgNaturalWidth},DrawlinesQuestion.prototype.handleElementScale=function(element){var bgRatio=this.bgRatio();this.isPrinting&&(bgRatio=1),element.setAttribute("transform","scale("+bgRatio+")")},DrawlinesQuestion.prototype.getRoot=function(){return document.getElementById(this.containerId)},DrawlinesQuestion.prototype.bgImage=function(){return this.getRoot().querySelector("img.dropbackground")},DrawlinesQuestion.prototype.getSVGLineCoordinates=function(svgEl){return[svgEl.childNodes[1].getAttribute("cx")+","+svgEl.childNodes[1].getAttribute("cy")+";"+svgEl.childNodes[1].getAttribute("r"),svgEl.childNodes[2].getAttribute("cx")+","+svgEl.childNodes[2].getAttribute("cy")+";"+svgEl.childNodes[2].getAttribute("r")]},DrawlinesQuestion.prototype.addToSvg=function(lineNumber,svg){let bgImage=this.bgImage();this.lineSVGs[lineNumber]=this.lines[lineNumber].makeSvg(svg,bgImage.naturalWidth,bgImage.naturalHeight),this.lineSVGs[lineNumber]&&(this.lineSVGs[lineNumber].setAttribute("data-dropzone-no",lineNumber),"dropzones"===svg.getAttribute("class")?this.lineSVGs[lineNumber].setAttribute("class","dropzone choice"+lineNumber+" placed"):this.lineSVGs[lineNumber].setAttribute("class","dropzone choice"+lineNumber+" inactive"))},DrawlinesQuestion.prototype.updateSvgEl=function(dropzoneNo){var bgimage=this.bgImage();this.lines[dropzoneNo].updateSvg(this.lineSVGs[dropzoneNo],bgimage.naturalWidth,bgimage.naturalHeight)},DrawlinesQuestion.prototype.handleCircleMove=function(e,whichHandle,dropzoneNo){var info=dragDrop.prepare(e);if(info.start){var movingDropZone=this,lastX=info.x,lastY=info.y,dragProxy=this.makeDragProxy(info.x,info.y),bgimage=this.bgImage(),maxX=bgimage.naturalWidth,maxY=bgimage.naturalHeight;dragDrop.start(e,$(dragProxy),(function(pageX,pageY){movingDropZone.lines[dropzoneNo].move(whichHandle,parseInt(pageX)-parseInt(lastX),parseInt(pageY)-parseInt(lastY),parseInt(maxX),parseInt(maxY)),lastX=pageX,lastY=pageY,movingDropZone.updateSvgEl(dropzoneNo),movingDropZone.saveCoordsForChoice(dropzoneNo)}),(function(){document.body.removeChild(dragProxy)}))}},DrawlinesQuestion.prototype.handleLineMove=function(e,dropzoneNo){var info=dragDrop.prepare(e);if(!info.start)return;var maxX,maxY,isMoveFromDragsToDropzones,isMoveFromDropzonesToDrags,svgClass,movingDrag=this,lastX=info.x,lastY=info.y,dragProxy=this.makeDragProxy(info.x,info.y),bgImage=this.bgImage(),selectedElement=this.lineSVGs[dropzoneNo];let dropX,dropY;"mousedown"===e.type?(dropX=e.clientX,dropY=e.clientY):"touchstart"===e.type&&(dropX=e.touches[0].clientX,dropY=e.touches[0].clientY),dragDrop.start(e,$(dragProxy),(function(pageX,pageY){var closestSVGs=movingDrag.getSvgsClosestToElement(selectedElement),closeTo=selectedElement.closest("svg");svgClass=closeTo.getAttribute("class"),isMoveFromDragsToDropzones="dragshome"===svgClass,isMoveFromDropzonesToDrags="dropzones"===svgClass&&movingDrag.lines[dropzoneNo].centre1.y>bgImage.naturalHeight-20,(isMoveFromDragsToDropzones||isMoveFromDropzonesToDrags)&&movingDrag.lines[dropzoneNo].addToDropZone("mouse",selectedElement,closestSVGs.svgDropZone,closestSVGs.svgDragsHome,dropX,dropY,bgImage.naturalHeight),closeTo=selectedElement.closest("svg");var dimensions=movingDrag.getSvgDimensionsByClass(closeTo,closeTo.getAttribute("class"));maxX=dimensions.maxX,maxY=dimensions.maxY,"DropZonesSVG"===dimensions.whichSVG&&(movingDrag.lines[dropzoneNo].moveDrags(parseInt(pageX)-parseInt(lastX),parseInt(pageY)-parseInt(lastY),parseInt(maxX),parseInt(maxY)),lastX=pageX,lastY=pageY),movingDrag.updateSvgEl(dropzoneNo),movingDrag.saveCoordsForChoice(dropzoneNo)}),(function(){document.body.removeChild(dragProxy)}))},DrawlinesQuestion.prototype.makeDragProxy=function(x,y){var dragProxy=document.createElement("div");return dragProxy.style.position="absolute",dragProxy.style.top=y+"px",dragProxy.style.left=x+"px",dragProxy.style.width="1px",dragProxy.style.height="1px",document.body.appendChild(dragProxy),dragProxy},DrawlinesQuestion.prototype.saveCoordsForChoice=function(choiceNo){let imageCoords=[];var items=this.getRoot().querySelector("svg g.choice"+choiceNo),gEleClassAttributes="";items&&(imageCoords=items.querySelector("polyline").getAttribute("points"),gEleClassAttributes=items.getAttribute("class")),""!==gEleClassAttributes&&gEleClassAttributes.includes("placed")?this.getRoot().querySelector("input.choice"+choiceNo).value=imageCoords:""!==gEleClassAttributes&&gEleClassAttributes.includes("inactive")&&(this.getRoot().querySelector("input.choice"+choiceNo).value="")},DrawlinesQuestion.prototype.handleKeyPress=function(e,drag,dropzoneNo,activeElement){var dropzoneElement,x=0,y=0,question=questionManager.getQuestionForEvent(e);switch(dropzoneElement=drag.closest("g"),e.code){case"ArrowLeft":case"KeyA":x=-1;break;case"ArrowRight":case"KeyD":x=1;break;case"ArrowDown":case"KeyS":y=1;break;case"ArrowUp":case"KeyW":y=-1;break;case"Space":case"Escape":break;default:return}e.preventDefault();var maxX,maxY,whichSVG,closeTo=drag.closest("svg"),svgClass=closeTo.getAttribute("class"),bgImage=this.bgImage(),closestSVGs=this.getSvgsClosestToElement(drag),isMoveFromDragsToDropzones="dragshome"===svgClass,isMoveFromDropzonesToDrags="dropzones"===svgClass&&question.lines[dropzoneNo].centre1.y>bgImage.naturalHeight-20;isMoveFromDragsToDropzones?question.lines[dropzoneNo].addToDropZone("keyboard",dropzoneElement,closestSVGs.svgDropZone,closestSVGs.svgDragsHome,null,null,bgImage.naturalHeight,"DragsSVG"):isMoveFromDropzonesToDrags&&question.lines[dropzoneNo].addToDropZone("keyboard",dropzoneElement,closestSVGs.svgDropZone,closestSVGs.svgDragsHome,null,null,null,"DropZonesSVG"),closeTo=drag.closest("svg");var dimensions=question.getSvgDimensionsByClass(closeTo,closeTo.getAttribute("class"));maxX=dimensions.maxX,maxY=dimensions.maxY,whichSVG=dimensions.whichSVG,"line"===activeElement&&"DropZonesSVG"===whichSVG?question.lines[dropzoneNo].moveDrags(parseInt(x),parseInt(y),parseInt(maxX),parseInt(maxY)):question.lines[dropzoneNo].move(activeElement,parseInt(x),parseInt(y),parseInt(maxX),parseInt(maxY)),question.updateSvgEl(dropzoneNo),this.saveCoordsForChoice(dropzoneNo),drag.focus()},DrawlinesQuestion.prototype.getSvgDimensionsByClass=function(dragSVG,className){let bgImg=this.bgImage();return{maxX:bgImg.naturalWidth,maxY:bgImg.naturalHeight,whichSVG:"dragshome"===className?"DragsSVG":"DropZonesSVG"}},DrawlinesQuestion.prototype.getSvgsClosestToElement=function(dragElement){var svgDragsHome,svgDropZone,svgElement=dragElement.closest("svg");return"dragshome"===svgElement.getAttribute("class")?(svgDragsHome=svgElement,svgDropZone=svgElement.closest(".ddarea").querySelector(".dropzones")):(svgDropZone=svgElement,svgDragsHome=svgElement.closest(".ddarea").querySelector(".dragshome")),{svgDropZone:svgDropZone,svgDragsHome:svgDragsHome}},DrawlinesQuestion.prototype.createSvgOnImageLoad=function(img){img?img.complete&&0!==img.naturalHeight?this.drawDropzone():img.addEventListener("load",(()=>this.drawDropzone())):window.console.error("Image with id '".concat(img,"' not found."))};var questionManager={eventHandlersInitialised:!1,lineEventHandlersInitialised:{},isPrinting:!1,isKeyboardNavigation:!1,questions:{},noOfLines:null,dropZones:[],questionLines:[],init:function(containerId,readOnly,visibleDropZones,questionLines){if(questionManager.questions[containerId]=new DrawlinesQuestion(containerId,readOnly,visibleDropZones,questionLines),questionManager.questions[containerId].updateCoordinates(),!questionManager.eventHandlersInitialised){const dropareaimages=document.querySelectorAll(".drawlines .droparea img");questionManager.checkAllImagesLoaded(dropareaimages).then((dropareaimages=>(questionManager.setupEventHandlers(),questionManager.eventHandlersInitialised=!0,dropareaimages))).catch((error=>window.console.error(error)))}if(!questionManager.lineEventHandlersInitialised.hasOwnProperty(containerId)){questionManager.lineEventHandlersInitialised[containerId]=!0;var questionContainer=document.getElementById(containerId);if(questionContainer.classList.contains("drawlines")&&!questionContainer.classList.contains("qtype_drawlines-readonly")){var dropArea=questionContainer.querySelector(".droparea");dropArea.addEventListener("mousedown",questionManager.handleDropZoneEventMove),dropArea.addEventListener("touchstart",questionManager.handleDropZoneEventMove),dropArea.addEventListener("keydown",questionManager.handleKeyPress),dropArea.addEventListener("keypress",questionManager.handleKeyPress),dropArea.addEventListener("focusin",(function(e){questionManager.handleKeyboardFocus(e,!0)})),dropArea.addEventListener("focusout",(function(e){questionManager.handleKeyboardFocus(e,!1)}));var drags=questionContainer.querySelector(".draghomes");drags.addEventListener("mousedown",questionManager.handleDragHomeEventMove),drags.addEventListener("touchstart",questionManager.handleDragHomeEventMove),drags.addEventListener("keydown",questionManager.handleKeyPress),drags.addEventListener("keypress",questionManager.handleKeyPress),drags.addEventListener("focusin",(function(e){questionManager.handleKeyboardFocus(e,!0)})),drags.addEventListener("focusout",(function(e){questionManager.handleKeyboardFocus(e,!1)}))}}},checkAllImagesLoaded:function(images){const promises=Array.from(images).map((img=>new Promise(((resolve,reject)=>{img.complete&&0!==img.naturalHeight?resolve(img):(img.addEventListener("load",(()=>resolve(img)),{once:!0}),img.addEventListener("error",(()=>reject(new Error("Failed to load image: ".concat(img.src)))),{once:!0}))}))));return Promise.all(promises)},setupEventHandlers:function(){window.addEventListener("resize",(function(){questionManager.handleWindowResize(!1)})),window.addEventListener("beforeprint",(function(){questionManager.isPrinting=!0,questionManager.handleWindowResize(questionManager.isPrinting)})),window.addEventListener("afterprint",(function(){questionManager.isPrinting=!1,questionManager.handleWindowResize(questionManager.isPrinting)})),setTimeout((function(){questionManager.fixLayoutIfThingsMoved()}),100)},fixLayoutIfThingsMoved:function(){questionManager.isKeyboardNavigation||this.handleWindowResize(questionManager.isPrinting),setTimeout((function(){questionManager.fixLayoutIfThingsMoved(questionManager.isPrinting)}),100)},handleDropZoneEventMove:function(event){var dropzoneNo,question=questionManager.getQuestionForEvent(event);event.target.closest(".dropzone .startcircle.shape")?(dropzoneNo=event.target.closest("g").dataset.dropzoneNo,question.handleCircleMove(event,"startcircle",dropzoneNo)):event.target.closest(".dropzone .endcircle.shape")?(dropzoneNo=event.target.closest("g").dataset.dropzoneNo,question.handleCircleMove(event,"endcircle",dropzoneNo)):event.target.closest("polyline.shape")&&(dropzoneNo=event.target.closest("g").dataset.dropzoneNo,question.handleLineMove(event,dropzoneNo))},handleDragHomeEventMove:function(event){let dropzoneElement,dropzoneNo,question=questionManager.getQuestionForEvent(event);event.target.closest("g")&&(dropzoneElement=event.target.closest("g"),dropzoneNo=dropzoneElement.dataset.dropzoneNo,question.handleLineMove(event,dropzoneNo),question.saveCoordsForChoice(dropzoneNo))},handleKeyPress:function(e){var dropzoneElement,dropzoneNo,drag,activeElement,question=questionManager.getQuestionForEvent(e);e.target.closest(".dropzone circle.startcircle")?(dropzoneNo=(dropzoneElement=e.target.closest(".dropzone")).dataset.dropzoneNo,drag=e.target.closest(".dropzone circle.startcircle"),activeElement="startcircle"):e.target.closest(".dropzone circle.endcircle")?(drag=e.target.closest(".dropzone circle.endcircle"),dropzoneNo=(dropzoneElement=e.target.closest(".dropzone")).dataset.dropzoneNo,activeElement="endcircle"):e.target.closest("g.dropzone")&&(drag=e.target.closest("g.dropzone"),dropzoneNo=(dropzoneElement=e.target.closest(".dropzone")).dataset.dropzoneNo,activeElement="line"),question&&dropzoneElement&&question.handleKeyPress(e,drag,dropzoneNo,activeElement)},handleWindowResize:function(isPrinting){for(var containerId in questionManager.questions)questionManager.questions.hasOwnProperty(containerId)&&(questionManager.questions[containerId].isPrinting=isPrinting,questionManager.questions[containerId].handleResize())},handleKeyboardFocus:function(e,isNavigating){questionManager.isKeyboardNavigation=isNavigating},getQuestionForEvent:function(e){var containerId=$(e.currentTarget).closest(".que.drawlines").attr("id");return questionManager.questions[containerId]}};return{init:questionManager.init}}));

//# sourceMappingURL=question.min.js.map